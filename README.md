# Симуляция и оптимизация параметров гидроакустического сонара

## 1. Цель проекта

Разработка программного комплекса для симуляции и оптимизации гидроакустического сонара, позволяющего:

- оценивать точность измерения глубины и дальности,
- анализировать влияние параметров среды (температура, солёность, глубина),
- оптимизировать CHIRP-сигнал и параметры приёмного тракта (LNA, VGA, ADC),
- находить оптимальные условия работы в случае несоответствия исходных параметров.

## 2. Архитектура системы

Программный комплекс состоит из трёх модулей:

```
┌──────────────────────────┐
│           GUI            │
│  Ввод и выбор параметров │
│  Визуализация результатов│
└────────────▲─────────────┘
             │ DTO
┌────────────┴─────────────┐
│           CORE           │
│  Симуляция и оптимизация │
│  Физические модели       │
└────────────▲─────────────┘
             │ API
┌────────────┴─────────────┐
│           DATA           │
│  База параметров         │
│  Трансдусеры, LNA, VGA, ADC │
└──────────────────────────┘
```

### 2.1 Модуль CORE (вычислительное ядро)

**Назначение:**

- моделирование гидроакустического канала;
- моделирование передающего и приёмного трактов;
- генерация и обработка CHIRP-сигнала;
- расчёт дальности и ошибки измерения;
- итеративная оптимизация параметров.

**Требования:**

- Детерминированность вычислений;
- Возможность batch-симуляций;
- Логирование всех входных и выходных данных;
- Unit-тестируемость;
- Обработка ошибок при несовместимых входных данных.

**Подсистемы:**

- **WaterModel** — вычисление скорости звука c(T,S,P) и затухания α(f,T,S,P)
- **TransducerModel** — модель трансдусера (частотные характеристики, TX/RX чувствительность, диаграмма направленности, ring-down)
- **SignalModel** — генерация CHIRP: f_start, f_end, Tp, оконная функция
- **ChannelModel** — моделирование затухания и потерь распространения TL(D,f)
- **ReceiverModel** — LNA, VGA, ADC, SNR и клиппинг
- **DSPModel** — обработка сигнала, TOF, расчет дальности
- **RangeEstimator** — расчет D_measured и σ_D
- **Optimizer** — поиск оптимальных параметров при нарушении ограничений

### 2.2 Модуль GUI

**Назначение:**

- выбор моделей из DATA;
- ввод параметров среды, CHIRP, диапазона глубин;
- запуск симуляции и визуализация результатов;
- предоставление возможности итеративной коррекции входных данных.

**Функции:**

- ввод параметров и выбор моделей;
- отображение ошибок и рекомендаций CORE;
- автоматическое или ручное изменение DTO для оптимизации;
- визуализация графиков: SNR, σ_D, D_min/D_max, спектр сигнала, Pareto-кривые;
- экспорт данных (CSV, JSON, PDF).

### 2.3 Модуль DATA

**Назначение:**

- централизованное хранение справочных данных:
  - трансдусеры,
  - LNA,
  - VGA,
  - ADC;
- предоставление API для CORE и GUI;
- неизменяемость данных во время симуляции.

**Формат хранения:**

- JSON формат для всех данных;
- версионирование через `metadata.json`;

## 3. Параметры среды

| Параметр | Обозначение | Диапазон |
|----------|-------------|----------|
| Температура | T | 0 – 30 °C |
| Солёность | S | 0 – 35 PSU |
| Глубина | z | 0.2 – 300 м |
| Давление | P | функция глубины |

**Выходы модели среды:**

- скорость звука c(T,S,P);
- коэффициент затухания α(f,T,S,P);
- потери распространения TL(D,f).

## 4. Аппаратные параметры

### 4.1 Трансдусеры

| Параметр | Обозначение |
|----------|-------------|
| Модель | - |
| f_min, f_max, f_0 | - |
| Полоса −3 dB | B_tr |
| TX/RX чувствительность | S_TX / S_RX |
| Диаграмма направленности | Θ_BW |
| Q-фактор | Q |
| Ring-down | T_rd |
| Импеданс | Z |
| Источник и версия | - |

### 4.2 LNA

| Параметр | Обозначение |
|----------|-------------|
| Усиление | G_LNA |
| Коэффициент шума | NF_LNA |
| Полоса | BW_LNA |
| Входной импеданс | Z_in |
| Максимальный вход | V_max |

### 4.3 VGA

| Параметр | Обозначение |
|----------|-------------|
| Диапазон усиления | G_min – G_max |
| Шаг усиления | ΔG |
| Полоса | BW_VGA |
| Время установки | T_set |
| Управление | аналог / цифровое |

### 4.4 ADC

| Параметр | Обозначение |
|----------|-------------|
| Разрядность | N |
| Частота дискретизации | f_s |
| Полная шкала | V_FS |
| ENOB | - |
| SNR | - |
| INL / DNL | - |

## 5. Параметры CHIRP-сигнала

| Параметр | Обозначение | Диапазон |
|----------|-------------|----------|
| f_start, f_end | - | f_min ≤ f ≤ f_max трансдусера |
| Полоса | B | ≤ B_tr |
| Длительность | Tp | 50 – 5000 мкс |
| Оконная функция | - | Rect / Hann / Tukey |

**Ограничения CORE:**

- `fs_ADC ≥ 2 × f_end`
- Полоса CHIRP ≤ B_tr
- D_min ≥ аппаратное D_min

## 6. Ограничения и метрики

| Параметр | Ограничение / Цель |
|----------|-------------------|
| D_min | ≥ D_min_target |
| D_max | ≥ D_max_target |
| σ_D | ≤ 1 см |
| SNR_ADC | ≥ SNR_min (Target SNR) |
| Clipping ADC | отсутствует |

## 7. Итеративная оптимизация входных данных

1. CORE выполняет симуляцию.
2. Если условия нарушены, CORE возвращает failure flag + рекомендации.
3. GUI / внешний optimizer корректирует DTO:
   - Tp, f_start/f_end, G_VGA(t), выбор других моделей трансдусера / LNA / ADC.
4. Повтор симуляции до достижения условий или исчерпания итераций.
5. Все итерации логируются.

## 8. Контракты данных

### 8.1 Входной DTO

```json
{
  "hardware": { 
    "transducer_id": "", 
    "lna_id": "", 
    "vga_id": "", 
    "adc_id": "" 
  },
  "signal": { 
    "f_start": 0, 
    "f_end": 0, 
    "Tp": 0.0,
    "sample_rate": 2000000.0
  },
  "environment": { 
    "T": 0, 
    "S": 0,
    "z": 0,
    "bottom_reflection": -15.0
  },
  "range": { 
    "D_min": 0, 
    "D_max": 0,
    "D_target": 0
  },
  "target_snr": 20.0
}
```

### 8.2 Выходной DTO

```json
{
  "D_measured": 0,
  "sigma_D": 0,
  "SNR_ADC": 0,
  "clipping_flags": false,
  "success": true,
  "recommendations": { 
    "increase_Tp": false, 
    "decrease_f0": false,
    "message": ""
  }
}
```

## 9. Требования к модулю GUI

- Выбор и отображение данных DATA.
- Формирование корректного входного DTO для CORE.
- Валидация диапазонов и совместимости.
- Итеративная корректировка входных данных.
- Визуализация результатов и рекомендаций CORE.
- Экспорт логов и результатов.

## 10. Требования к модулю CORE

- Использует только входной DTO.
- Не изменяет DATA.
- Производит расчёты и возвращает метрики и рекомендации.
- Логирует версии DATA, входные DTO и результаты.

## 11. Требования к модулю DATA

- Централизованное хранение справочных данных.
- Не изменяется во время симуляции.
- Версионируется.
- Доступ через API (CORE / GUI).

## 12. Формулы, используемые в модуле CORE

Модуль CORE использует следующие физические и математические формулы для расчётов:

### 12.1 Скорость звука в воде

**Формула Mackenzie (1981):**

$$
\begin{aligned}
c &= 1448.96 + 4.591T - 5.304 \times 10^{-2}T^2 + 2.374 \times 10^{-4}T^3 \\
&\quad + 1.340(S - 35) + 1.630 \times 10^{-2}P + 1.675 \times 10^{-7}P^2 \\
&\quad - 1.025 \times 10^{-2}T(S - 35) - 7.139 \times 10^{-13}TP^3
\end{aligned}
$$

где:
- $c$ — скорость звука, м/с
- $T$ — температура, °C (0–30)
- $S$ — солёность, PSU (0–35)
- $P$ — давление, dBar

**Давление на глубине:**

$$
P = 1.0 + 0.1z
$$

где $z$ — глубина, м

### 12.2 Затухание звука в воде

**Формула Francois-Garrison:**

Коэффициент затухания $\alpha$ (Np/m) рассчитывается как сумма трёх компонент:

$$
\alpha = \frac{A_1 P_1 f_1 f^2}{f_1^2 + f^2} + \frac{A_2 P_2 f_2 f^2}{f_2^2 + f^2} + \frac{A_3 P_3 f_3 f^2}{f_3^2 + f^2}
$$

где:
- Первая компонента — вязкое затухание
- Вторая компонента — релаксационное затухание (борная кислота B(OH)₃)
- Третья компонента — релаксационное затухание (сульфат магния MgSO₄)

Коэффициенты зависят от температуры $T$, солёности $S$ и давления $P$.

**Перевод в децибелы:**

$$
\alpha_{dB} = \alpha \times 8.686 \quad \text{(dB/m)}
$$

### 12.3 Потери распространения (Transmission Loss)

**Потери на расхождение (Spreading Loss):**

Для сферического распространения:

$$
TL_{spread} = 20 \log_{10}(D)
$$

где $D$ — дальность, м

**Потери на поглощение (Absorption Loss):**

$$
TL_{abs} = \alpha_{dB} \times D
$$

**Общие потери распространения:**

$$
TL = TL_{spread} + TL_{abs} = 20 \log_{10}(D) + \alpha_{dB} \times D
$$

### 12.4 Уравнение сонара (Active Sonar Equation)

**Основное уравнение:**

$$
SNR = SL + TS + DI - NL - 2TL + 10\log_{10}(BT)
$$

где:
- **SNR** — отношение сигнал/шум на выходе приёмника, дБ
- **SL** — уровень источника (Source Level), дБ re 1µPa @ 1м
  $$
  SL = S_{TX} + 20\log_{10}(V)
  $$
  где $S_{TX}$ — чувствительность передатчика, дБ re 1µPa/V @ 1м; $V$ — напряжение передатчика, В
- **TS** — сила цели (Target Strength), дБ
  $$
  TS = -R_{bottom}
  $$
  где $R_{bottom}$ — коэффициент отражения дна (отрицательное значение, потери при отражении)
- **DI** — индекс направленности (Directivity Index), дБ (принимается равным 0 для всенаправленного трансдусера)
- **NL** — уровень шума (Noise Level), дБ re 1µPa
  $$
  NL = NL_{spectrum} + 10\log_{10}\left(\frac{BW}{1 \text{ кГц}}\right) + \text{вклад LNA}
  $$
  где $NL_{spectrum}$ — спектральный уровень шума (обычно ~120 дБ re 1µPa @ 1 кГц); $BW$ — полоса пропускания, Гц
- **TL** — потери распространения на пути в одну сторону, дБ
- **2TL** — потери распространения на пути туда-обратно, дБ
- **BT** — произведение полосы на время (pulse compression product)
  $$
  BT = B \times T_p
  $$
  где $B$ — полоса CHIRP-сигнала, Гц; $T_p$ — длительность импульса, с
- **$10\log_{10}(BT)$** — выигрыш от сжатия импульса (pulse compression gain), дБ

**Расчёт оптимальной длительности импульса:**

Из уравнения сонара можно найти требуемую длительность импульса:

$$
\begin{aligned}
10\log_{10}(BT) &= SNR_{target} - (SL + TS + DI - NL - 2TL) \\
BT &= 10^{\frac{SNR_{target} - (SL + TS + DI - NL - 2TL)}{10}} \\
T_p &= \frac{BT}{B} \quad \text{(секунды)}
\end{aligned}
$$

### 12.5 Точность измерения дальности

**Граница Крамера-Рао (Cramér-Rao Lower Bound):**

$$
\sigma_D = \frac{c}{2 \times BW_{eff} \times \sqrt{SNR}}
$$

где:
- $\sigma_D$ — стандартное отклонение измерения дальности, м
- $c$ — скорость звука, м/с
- $BW_{eff}$ — эффективная полоса пропускания, Гц
  $$
  BW_{eff} = \max\left(B, \frac{1}{T_p}\right)
  $$
  где $B$ — полоса CHIRP-сигнала, Гц; $T_p$ — длительность импульса, с
- **SNR** — отношение сигнал/шум (линейное, не в дБ)
  $$
  SNR = 10^{\frac{SNR_{dB}}{10}}
  $$

### 12.6 Время распространения и дальность

**Время распространения (Time of Flight, TOF):**

$$
TOF = \frac{2D}{c}
$$

где $D$ — дальность (путь в одну сторону), м

**Измеренная дальность:**

$$
D_{measured} = \frac{TOF \times c}{2}
$$

### 12.7 Ограничения на длительность импульса

**Максимальная длительность импульса:**

Длительность импульса ограничена временем распространения до минимальной дальности:

$$
T_{p,max} = 0.8 \times TOF_{min} = 0.8 \times \frac{2D_{min}}{c}
$$

где $D_{min}$ — минимальная дальность, м

Это ограничение гарантирует, что передача сигнала завершится до прихода отражённого сигнала от минимальной дальности.

### 12.8 Обработка сигнала

**Согласованная фильтрация (Matched Filtering):**

Корреляция принятого сигнала с опорным сигналом:

$$
y[n] = \sum_{k=0}^{N-1} x[n+k] \cdot h[k]
$$

где:
- $x[n]$ — принятый сигнал
- $h[k]$ — опорный сигнал (CHIRP)
- $y[n]$ — выход согласованного фильтра

**Определение TOF:**

TOF определяется как положение максимума выходного сигнала согласованного фильтра с использованием параболической интерполяции для субсэмпловой точности.

### 12.9 Расчёт ENOB для акустического сонарного тракта

**Структура тракта:**

Гидрофон → LNA → VGA/PGA → ADC → Цифровая обработка (корреляция)

#### 12.9.1 Определения

**LNA** — предусилитель низкого шума

- Усиление: $G_{LNA}$ (линейное, ×)
- Входной шум: $e_{n,LNA}$ [V/√Hz]

**VGA/PGA** — программируемый/регулируемый усилитель

- Усиление: $G_{VGA}$ (×)
- Шум: $e_{n,VGA}$ [V/√Hz]

**ADC** — аналого-цифровой преобразователь

- Полный диапазон: $V_{FS}$
- Биты: $N_{ADC}$

**Сигнал CHIRP**

- Полоса: $BW$ [Hz]
- Длительность: $T_{chirp}$ [s]
- Количество сэмплов: $N_s = T_{chirp} \cdot F_s$

#### 12.9.2 Шум на выходе каждого каскада

**RMS шум LNA:**

$$
v_{n,LNA,rms} = e_{n,LNA} \cdot \sqrt{BW}
$$

**Выход LNA:**

$$
v_{n,LNA,out} = v_{n,LNA,rms} \cdot G_{LNA}
$$

**RMS шум VGA/PGA:**

$$
v_{n,VGA,rms} = e_{n,VGA} \cdot \sqrt{BW}
$$

**Выход VGA/PGA:**

$$
v_{n,VGA,out} = v_{n,VGA,rms} \cdot G_{VGA}
$$

**Общий RMS шум на выходе VGA/PGA:**

$$
v_{n,total} = \sqrt{(v_{n,LNA,out} \cdot G_{VGA})^2 + (v_{n,VGA,out})^2}
$$

Здесь учтено, что шум LNA также усиливается VGA.

#### 12.9.3 RMS сигнал на выходе VGA/PGA

Сигнал на гидрофоне: $V_{signal,in}$ [V]

$$
V_{signal,out} = V_{signal,in} \cdot G_{LNA} \cdot G_{VGA}
$$

#### 12.9.4 Аналоговый SNR

$$
SNR_{analog} = 20 \cdot \log_{10}\left(\frac{V_{signal,out}}{v_{n,total}}\right)
$$

#### 12.9.5 Аналоговый ENOB

$$
ENOB_{analog} = \frac{SNR_{analog} - 1.76}{6.02}
$$

Если сигнал мал, ENOB может быть значительно меньше номинала ADC.

#### 12.9.6 Эффект корреляции / CWT

Корреляция CHIRP / matched filtering повышает SNR на $\sqrt{N_s}$, где $N_s$ — количество сэмплов CHIRP:

$$
SNR_{digital} = SNR_{analog} + 20 \cdot \log_{10}(\sqrt{N_s}) = SNR_{analog} + 10 \cdot \log_{10}(N_s)
$$

Соответственно, цифровой ENOB после корреляции:

$$
ENOB_{digital} = \frac{SNR_{digital} - 1.76}{6.02}
$$

#### 12.9.7 Полный алгоритм расчёта ENOB

1. Выбираем LNA и VGA/PGA, задаём шум $e_n$ и усиление $G$.
2. Рассчитываем RMS шум на выходе каждого каскада по формулам (12.9.2).
3. Определяем RMS сигнал на выходе VGA/PGA.
4. Вычисляем аналоговый SNR (12.9.4) и ENOB (12.9.5).
5. Определяем количество сэмплов CHIRP: $N_s = T_{chirp} \cdot F_s$.
6. Учитываем эффект корреляции/CWT (12.9.6).
7. Получаем цифровой ENOB после обработки (12.9.6).

**Пример:**

- $V_{signal,in} = 1$ µV
- $BW = 50$ kHz
- $e_{n,LNA} = 0.9$ nV/√Hz, $G_{LNA} = 10$
- $e_{n,VGA} = 1$ nV/√Hz, $G_{VGA} = 1000$
- ADC: ±1 V, 16 бит
- $T_{chirp} = 500$ µs, $F_s = 5$ MSPS ⇒ $N_s = 2500$

**Результат:**

- $v_{n,total} \approx 2$ mV
- $V_{signal,out} \approx 10$ mV
- $SNR_{analog} \approx 13.9$ dB ⇒ $ENOB_{analog} \approx 2$ бит
- После корреляции: $SNR_{digital} = 13.9 + 10\log_{10}(2500) \approx 48$ dB ⇒ $ENOB_{digital} \approx 7.7$ бит

## 13. Проверка и Acceptance criteria

| Проверка | Описание |
|----------|----------|
| Симуляция без GUI невозможна | GUI обязателен для запуска |
| Несовместимые данные → CORE возвращает рекомендации | Валидация и рекомендации работают |
| Итеративная корректировка приводит к удовлетворению ограничений | Оптимизация работает |
| Повторная симуляция идентична с тем же DTO | Детерминированность |
| Логирование всех итераций и версий DATA | Полное логирование |

---

## 14. Реализованные функции (Completed Features)

### 14.1 Основной функционал

- ✅ Полная симуляция гидроакустического сонара с моделями всех компонентов
- ✅ Генерация CHIRP-сигналов с настраиваемыми параметрами
- ✅ Моделирование распространения сигнала в воде (затухание, расхождение)
- ✅ Моделирование приемного тракта (LNA, VGA, ADC)
- ✅ DSP обработка (согласованная фильтрация, расчет TOF)
- ✅ Расчет измеренной дальности (D_measured) и неопределенности (σ_D)

### 14.2 Визуализация

- ✅ Графики сигналов: переданный CHIRP, принятый сигнал, выход согласованного фильтра
- ✅ Новые графики в разделе "Signals RX":
  - Сигнал после LNA (с указанием усиления)
  - Сигнал после VGA (с указанием усиления)
- ✅ Диаграмма Signal Path с отображением потерь на каждом этапе
- ✅ SUMMARY секция в Signal Path с итоговыми параметрами

### 14.3 Сохранение и загрузка параметров

- ✅ Автоматическое сохранение всех параметров GUI в `gui.json`
- ✅ Автоматическая загрузка параметров при запуске
- ✅ Сохранение выбора аппаратуры (трансдусер, LNA, VGA, ADC)
- ✅ Сохранение параметров сигнала, среды, дальности
- ✅ Сохранение опций (link_depth_to_range)

### 14.4 Оптимизация и рекомендации

- ✅ Оптимизатор анализирует результаты и проверяет ограничения:
  - Точность дальности (σ_D ≤ 0.01 м)
  - Качество сигнала (SNR ≥ Target SNR)
  - Отсутствие клиппинга
  - Валидность дальности
- ✅ Генерация рекомендаций с конкретными значениями:
  - Текущие значения параметров → Рекомендуемые значения
  - Процент изменения для каждого параметра
- ✅ Справка о работе симулятора и оптимизатора в разделе Recommendations
- ✅ Использование Target SNR из GUI для оптимизации

### 14.5 Поддержка оборудования

- ✅ Добавлена поддержка ADC:
  - ADS7056
  - AD7091
- ✅ База данных трансдусеров, LNA, VGA, ADC в формате JSON

---

## 15. Планируемые улучшения (Planned Improvements)

### 15.1 Функциональность

- ⏳ Автоматическое применение рекомендаций оптимизатора (кнопка "Apply Recommendations")
- ⏳ Итеративная оптимизация с автоматическим перезапуском симуляции
- ⏳ Batch-симуляции для анализа параметров
- ⏳ Экспорт результатов в различные форматы (CSV, JSON, PDF)
- ⏳ Импорт/экспорт конфигураций симуляции

### 15.2 Визуализация

- ⏳ Дополнительные графики:
  - Спектр сигнала
  - Pareto-кривые для оптимизации
  - История итераций оптимизации
- ⏳ Интерактивные графики с возможностью масштабирования
- ⏳ 3D визуализация диаграммы направленности трансдусера

### 15.3 Оптимизация

- ⏳ Более сложные алгоритмы оптимизации (генетические алгоритмы, градиентный спуск)
- ⏳ Многокритериальная оптимизация (Pareto front)
- ⏳ Оптимизация с учетом ограничений аппаратуры
- ⏳ Автоматический подбор оптимального оборудования

### 15.4 Моделирование

- ⏳ Более детальное моделирование трансдусера (ring-down, диаграмма направленности)
- ⏳ Моделирование многолучевого распространения
- ⏳ Моделирование шумов среды (ветер, судоходство)
- ⏳ Моделирование движения цели

### 15.5 Тестирование и качество

- ⏳ Расширенное unit-тестирование всех модулей
- ⏳ Интеграционные тесты
- ⏳ Тесты производительности
- ⏳ Валидация результатов симуляции на реальных данных

### 15.6 Документация

- ⏳ API документация (Sphinx)
- ⏳ Руководство пользователя с примерами
- ⏳ Техническая документация по физическим моделям
- ⏳ Видео-туториалы

### 15.7 Пользовательский интерфейс

- ⏳ Темная тема
- ⏳ Настройка цветов графиков
- ⏳ Сохранение макетов окон
- ⏳ Горячие клавиши
- ⏳ Контекстная справка

### 15.8 Производительность

- ⏳ Оптимизация вычислений (NumPy векторизация, Numba JIT)
- ⏳ Кэширование результатов вычислений
- ⏳ Параллельные вычисления для batch-симуляций
- ⏳ Оптимизация памяти для больших сигналов
