# Симуляция и оптимизация параметров гидроакустического сонара

## 1. Цель проекта

Разработка программного комплекса для симуляции и оптимизации гидроакустического сонара, позволяющего:

- оценивать точность измерения глубины и дальности,
- анализировать влияние параметров среды (температура, солёность, глубина),
- оптимизировать CHIRP-сигнал и параметры приёмного тракта (LNA, VGA, ADC),
- находить оптимальные условия работы в случае несоответствия исходных параметров.

## 2. Архитектура системы

Программный комплекс состоит из трёх модулей:

```
┌──────────────────────────┐
│           GUI            │
│  Ввод и выбор параметров │
│  Визуализация результатов│
└────────────▲─────────────┘
             │ DTO
┌────────────┴─────────────┐
│           CORE           │
│  Симуляция и оптимизация │
│  Физические модели       │
└────────────▲─────────────┘
             │ API
┌────────────┴─────────────┐
│           DATA           │
│  База параметров         │
│  Трансдусеры, LNA, VGA, ADC │
└──────────────────────────┘
```

### 2.1 Модуль CORE (вычислительное ядро)

**Назначение:**

- моделирование гидроакустического канала;
- моделирование передающего и приёмного трактов;
- генерация и обработка CHIRP-сигнала;
- расчёт дальности и ошибки измерения;
- итеративная оптимизация параметров.

**Требования:**

- Детерминированность вычислений;
- Возможность batch-симуляций;
- Логирование всех входных и выходных данных;
- Unit-тестируемость;
- Обработка ошибок при несовместимых входных данных.

**Подсистемы:**

- **WaterModel** — вычисление скорости звука c(T,S,P) и затухания α(f,T,S,P)
- **TransducerModel** — модель трансдусера (частотные характеристики, TX/RX чувствительность, диаграмма направленности, ring-down)
- **SignalModel** — генерация CHIRP: f_start, f_end, Tp, оконная функция
- **ChannelModel** — моделирование затухания и потерь распространения TL(D,f)
- **ReceiverModel** — LNA, VGA, ADC, SNR и клиппинг
- **DSPModel** — обработка сигнала, TOF, расчет дальности
- **RangeEstimator** — расчет D_measured и σ_D
- **Optimizer** — поиск оптимальных параметров при нарушении ограничений

### 2.2 Модуль GUI

**Назначение:**

- выбор моделей из DATA;
- ввод параметров среды, CHIRP, диапазона глубин;
- запуск симуляции и визуализация результатов;
- предоставление возможности итеративной коррекции входных данных.

**Функции:**

- ввод параметров и выбор моделей;
- отображение ошибок и рекомендаций CORE;
- автоматическое или ручное изменение DTO для оптимизации;
- визуализация графиков: SNR, σ_D, D_min/D_max, спектр сигнала, Pareto-кривые;
- экспорт данных (CSV, JSON, PDF).

### 2.3 Модуль DATA

**Назначение:**

- централизованное хранение справочных данных:
  - трансдусеры,
  - LNA,
  - VGA,
  - ADC;
- предоставление API для CORE и GUI;
- неизменяемость данных во время симуляции.

**Формат хранения:**

- JSON формат для всех данных;
- версионирование через `metadata.json`;

## 3. Параметры среды

| Параметр | Обозначение | Диапазон |
|----------|-------------|----------|
| Температура | T | 0 – 30 °C |
| Солёность | S | 0 – 35 PSU |
| Глубина | z | 0.2 – 300 м |
| Давление | P | функция глубины |

**Выходы модели среды:**

- скорость звука c(T,S,P);
- коэффициент затухания α(f,T,S,P);
- потери распространения TL(D,f).

## 4. Аппаратные параметры

### 4.1 Трансдусеры

| Параметр | Обозначение |
|----------|-------------|
| Модель | - |
| f_min, f_max, f_0 | - |
| Полоса −3 dB | B_tr |
| TX/RX чувствительность | S_TX / S_RX |
| Диаграмма направленности | Θ_BW |
| Q-фактор | Q |
| Ring-down | T_rd |
| Импеданс | Z |
| Источник и версия | - |

### 4.2 LNA

| Параметр | Обозначение |
|----------|-------------|
| Усиление | G_LNA |
| Коэффициент шума | NF_LNA |
| Полоса | BW_LNA |
| Входной импеданс | Z_in |
| Максимальный вход | V_max |

### 4.3 VGA

| Параметр | Обозначение |
|----------|-------------|
| Диапазон усиления | G_min – G_max |
| Шаг усиления | ΔG |
| Полоса | BW_VGA |
| Время установки | T_set |
| Управление | аналог / цифровое |

### 4.4 ADC

| Параметр | Обозначение |
|----------|-------------|
| Разрядность | N |
| Частота дискретизации | f_s |
| Полная шкала | V_FS |
| ENOB | - |
| SNR | - |
| INL / DNL | - |

## 5. Параметры CHIRP-сигнала

| Параметр | Обозначение | Диапазон |
|----------|-------------|----------|
| f_start, f_end | - | f_min ≤ f ≤ f_max трансдусера |
| Полоса | B | ≤ B_tr |
| Длительность | Tp | 50 – 5000 мкс |
| Оконная функция | - | Rect / Hann / Tukey |

**Ограничения CORE:**

- `fs_ADC ≥ 2 × f_end`
- Полоса CHIRP ≤ B_tr
- D_min ≥ аппаратное D_min

## 6. Ограничения и метрики

| Параметр | Ограничение / Цель |
|----------|-------------------|
| D_min | ≥ D_min_target |
| D_max | ≥ D_max_target |
| σ_D | ≤ 1 см |
| SNR_ADC | ≥ SNR_min (Target SNR) |
| Clipping ADC | отсутствует |

## 7. Итеративная оптимизация входных данных

1. CORE выполняет симуляцию.
2. Если условия нарушены, CORE возвращает failure flag + рекомендации.
3. GUI / внешний optimizer корректирует DTO:
   - Tp, f_start/f_end, G_VGA(t), выбор других моделей трансдусера / LNA / ADC.
4. Повтор симуляции до достижения условий или исчерпания итераций.
5. Все итерации логируются.

## 8. Контракты данных

### 8.1 Входной DTO

```json
{
  "hardware": { 
    "transducer_id": "", 
    "lna_id": "", 
    "vga_id": "", 
    "adc_id": "" 
  },
  "signal": { 
    "f_start": 0, 
    "f_end": 0, 
    "Tp": 0.0,
    "sample_rate": 2000000.0
  },
  "environment": { 
    "T": 0, 
    "S": 0,
    "z": 0,
    "bottom_reflection": -15.0
  },
  "range": { 
    "D_min": 0, 
    "D_max": 0,
    "D_target": 0
  },
  "target_snr": 20.0
}
```

### 8.2 Выходной DTO

```json
{
  "D_measured": 0,
  "sigma_D": 0,
  "SNR_ADC": 0,
  "clipping_flags": false,
  "success": true,
  "recommendations": { 
    "increase_Tp": false, 
    "decrease_f0": false,
    "message": ""
  }
}
```

## 9. Требования к модулю GUI

- Выбор и отображение данных DATA.
- Формирование корректного входного DTO для CORE.
- Валидация диапазонов и совместимости.
- Итеративная корректировка входных данных.
- Визуализация результатов и рекомендаций CORE.
- Экспорт логов и результатов.

## 10. Требования к модулю CORE

- Использует только входной DTO.
- Не изменяет DATA.
- Производит расчёты и возвращает метрики и рекомендации.
- Логирует версии DATA, входные DTO и результаты.

## 11. Требования к модулю DATA

- Централизованное хранение справочных данных.
- Не изменяется во время симуляции.
- Версионируется.
- Доступ через API (CORE / GUI).

## 12. Проверка и Acceptance criteria

| Проверка | Описание |
|----------|----------|
| Симуляция без GUI невозможна | GUI обязателен для запуска |
| Несовместимые данные → CORE возвращает рекомендации | Валидация и рекомендации работают |
| Итеративная корректировка приводит к удовлетворению ограничений | Оптимизация работает |
| Повторная симуляция идентична с тем же DTO | Детерминированность |
| Логирование всех итераций и версий DATA | Полное логирование |

---

## 13. Реализованные функции (Completed Features)

### 13.1 Основной функционал

- ✅ Полная симуляция гидроакустического сонара с моделями всех компонентов
- ✅ Генерация CHIRP-сигналов с настраиваемыми параметрами
- ✅ Моделирование распространения сигнала в воде (затухание, расхождение)
- ✅ Моделирование приемного тракта (LNA, VGA, ADC)
- ✅ DSP обработка (согласованная фильтрация, расчет TOF)
- ✅ Расчет измеренной дальности (D_measured) и неопределенности (σ_D)

### 13.2 Визуализация

- ✅ Графики сигналов: переданный CHIRP, принятый сигнал, выход согласованного фильтра
- ✅ Новые графики в разделе "Signals RX":
  - Сигнал после LNA (с указанием усиления)
  - Сигнал после VGA (с указанием усиления)
- ✅ Диаграмма Signal Path с отображением потерь на каждом этапе
- ✅ SUMMARY секция в Signal Path с итоговыми параметрами

### 13.3 Сохранение и загрузка параметров

- ✅ Автоматическое сохранение всех параметров GUI в `gui.json`
- ✅ Автоматическая загрузка параметров при запуске
- ✅ Сохранение выбора аппаратуры (трансдусер, LNA, VGA, ADC)
- ✅ Сохранение параметров сигнала, среды, дальности
- ✅ Сохранение опций (link_depth_to_range)

### 13.4 Оптимизация и рекомендации

- ✅ Оптимизатор анализирует результаты и проверяет ограничения:
  - Точность дальности (σ_D ≤ 0.01 м)
  - Качество сигнала (SNR ≥ Target SNR)
  - Отсутствие клиппинга
  - Валидность дальности
- ✅ Генерация рекомендаций с конкретными значениями:
  - Текущие значения параметров → Рекомендуемые значения
  - Процент изменения для каждого параметра
- ✅ Справка о работе симулятора и оптимизатора в разделе Recommendations
- ✅ Использование Target SNR из GUI для оптимизации

### 13.5 Поддержка оборудования

- ✅ Добавлена поддержка ADC:
  - ADS7056
  - AD7091
- ✅ База данных трансдусеров, LNA, VGA, ADC в формате JSON

---

## 14. Планируемые улучшения (Planned Improvements)

### 14.1 Функциональность

- ⏳ Автоматическое применение рекомендаций оптимизатора (кнопка "Apply Recommendations")
- ⏳ Итеративная оптимизация с автоматическим перезапуском симуляции
- ⏳ Batch-симуляции для анализа параметров
- ⏳ Экспорт результатов в различные форматы (CSV, JSON, PDF)
- ⏳ Импорт/экспорт конфигураций симуляции

### 14.2 Визуализация

- ⏳ Дополнительные графики:
  - Спектр сигнала
  - Pareto-кривые для оптимизации
  - История итераций оптимизации
- ⏳ Интерактивные графики с возможностью масштабирования
- ⏳ 3D визуализация диаграммы направленности трансдусера

### 14.3 Оптимизация

- ⏳ Более сложные алгоритмы оптимизации (генетические алгоритмы, градиентный спуск)
- ⏳ Многокритериальная оптимизация (Pareto front)
- ⏳ Оптимизация с учетом ограничений аппаратуры
- ⏳ Автоматический подбор оптимального оборудования

### 14.4 Моделирование

- ⏳ Более детальное моделирование трансдусера (ring-down, диаграмма направленности)
- ⏳ Моделирование многолучевого распространения
- ⏳ Моделирование шумов среды (ветер, судоходство)
- ⏳ Моделирование движения цели

### 14.5 Тестирование и качество

- ⏳ Расширенное unit-тестирование всех модулей
- ⏳ Интеграционные тесты
- ⏳ Тесты производительности
- ⏳ Валидация результатов симуляции на реальных данных

### 14.6 Документация

- ⏳ API документация (Sphinx)
- ⏳ Руководство пользователя с примерами
- ⏳ Техническая документация по физическим моделям
- ⏳ Видео-туториалы

### 14.7 Пользовательский интерфейс

- ⏳ Темная тема
- ⏳ Настройка цветов графиков
- ⏳ Сохранение макетов окон
- ⏳ Горячие клавиши
- ⏳ Контекстная справка

### 14.8 Производительность

- ⏳ Оптимизация вычислений (NumPy векторизация, Numba JIT)
- ⏳ Кэширование результатов вычислений
- ⏳ Параллельные вычисления для batch-симуляций
- ⏳ Оптимизация памяти для больших сигналов
